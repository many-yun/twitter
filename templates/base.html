{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">
    <!-- Our project just needs Font Awesome Free's Solid and Brand files -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
    <title>Twitter</title>
</head>
<body>
    {% include "nav.html" %}
    <div class="infinite">
    {% block content %}
    {% endblock %}
    </div>  
    <div class="pagination"></div>
    {% block script %}
    <script>
        const replyBtn = document.getElementsByClassName("reply-btn")
        Array.from(replyBtn).forEach((e) => {
            e.addEventListener('click', () => {
                const replyForm = e.parentNode.nextElementSibling
                
                if(replyForm.style.display === "none"){
                    replyForm.style.display = "flex"
                }
                else replyForm.style.display = "none"
            })
        })
    
        const delete_btn = document.getElementsByClassName("delete-btn")
        Array.from(delete_btn).forEach(function(e){
            e.addEventListener('click', function() {
                if(confirm("정말로 삭제하시겠습니까?")){
                    location.href = this.dataset.uri
                }
            })
        })

        let settingMode = false
        const settingBtn = document.getElementsByClassName("setting-btn")
        const profile = document.getElementsByClassName("profile")[0]
        const profileText = document.getElementsByClassName("profile-text-wrap")[0]
        const profileForm = document.getElementsByClassName("profile-form-wrap")[0]

        Array.from(settingBtn).forEach(function(e) {
            e.addEventListener('click', function(){
                if(settingMode === false){
                    profile.classList.add("setting-mode")
                    settingMode = true
                    profileText.style.display = "none"
                    profileForm.style.display = "flex"
                }
                else {
                    profile.classList.remove("setting-mode")
                    settingMode = false
                    profileText.style.display = "flex"
                    profileForm.style.display = "none"
                }
            })
        })

        // 이미지 썸네일 미리보기
        function setThumbnail(event) {
            for (var image of event.target.files) {
              var reader = new FileReader();
    
              reader.onload = function(event) {
                var img = document.createElement("img");
                img.setAttribute("src", event.target.result);
                document.querySelector("div#image_container").appendChild(img);
              };
    
              console.log(image);
              reader.readAsDataURL(image);
            }
          }
        
        const url = window.location.href
        const currentUrl = url.split('?page=')[0]
        const urlParam = window.location.search
        const searchParams = new URLSearchParams(urlParam)
        const param = !searchParams.get('page') ? '1' : searchParams.get('page')
        let page = Number(param)

        function loadMoreData() {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", `${currentUrl}?page=${page + 1}`, true);

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const parser = new DOMParser()
                    const data = parser.parseFromString(xhr.responseText, 'text/html')
                    const twitBox = data.querySelectorAll('.twit-box')
                    const nextTwits = data.querySelector('.twit-list')

                    if(twitBox.length > 0) {
                        const twitList = document.querySelector('.twit-area')
                        twitList.appendChild(nextTwits)
                        page++
                    }
                    else {
                        console.log('No more data')
                    }
    
                }
            };
            xhr.send();
          }

          window.addEventListener('scroll', () => {
            let scrollLocation = document.documentElement.scrollTop; // 현재 스크롤바 위치
            let windowHeight = window.innerHeight; // 스크린 창
            let fullHeight = document.body.scrollHeight ; 
        
            if(scrollLocation + windowHeight >= fullHeight){
                loadMoreData()
            }
        })

    </script>
    {% endblock %}
</body>
</html>